<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Europe Countries, Capitals & Flags Trainer</title>
<style>
  :root {
    --fg:#111; --bg:#fafafa; --muted:#6b7280; --card:#fff; --border:#e5e7eb;
    --accent:#2563eb; --ok:#16a34a; --bad:#dc2626;
    --mapHl:#bfdbfe;          /* light blue */
    --mapHlStroke:#1e3a8a;    /* darker blue outline */
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  h1{font-size:20px;margin:0}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--border);background:var(--card);border-radius:999px;padding:6px 12px;font-size:14px}
  .pill.badge{border-color:#c7d2fe;background:#eef2ff}
  .sel{border:1px solid var(--border);background:var(--card);border-radius:10px;padding:6px 10px;font-size:14px}
  .btn{all:unset;cursor:pointer;border:1px solid var(--border);background:var(--card);padding:8px 12px;border-radius:10px}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .small{font-size:12px;color:var(--muted)}
  .progress{height:8px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 0 12px}
  .bar{height:100%;background:var(--accent);width:0%}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,.04);padding:16px}
  .mapbox{position:relative;display:flex;align-items:center;justify-content:center;min-height:320px}
  .mapbox svg, .mapbox object{max-width:100%;width:100%;display:block}
  .mapbox object{min-height:320px}
  .map-status{position:absolute;top:8px;left:8px;background:#fff;border:1px solid var(--border);padding:4px 8px;border-radius:8px}
  .meta{color:var(--muted);font-size:14px;margin-bottom:8px}
  .q{font-size:20px;line-height:1.35;margin:0 0 12px}
  .choices{display:grid;gap:10px}
  .choices.cols-6{grid-template-columns:repeat(3,minmax(0,1fr))}
  .choices.cols-8{grid-template-columns:repeat(4,minmax(0,1fr))}
  .choices.cols-9{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:520px){
    .choices.cols-6{grid-template-columns:repeat(2,minmax(0,1fr))}
    .choices.cols-8{grid-template-columns:repeat(2,minmax(0,1fr))}
    .choices.cols-9{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
  button.choice{all:unset;display:block;border:1px solid var(--border);background:var(--card);padding:12px 14px;border-radius:10px;cursor:pointer}
  button.choice:hover{border-color:#cfd7ff;background:#f6f8ff}
  button.choice.correct{border-color:var(--ok);background:#f0fbf4}
  button.choice.wrong{border-color:var(--bad);background:#fff5f5}
  .answer-row{display:flex;gap:8px;align-items:center}
  .answer-row input[type="text"]{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:16px}
  .feedback{font-size:18px;font-weight:700;margin-top:10px}
  .hide{display:none}

  /* Flag buttons */
  .flag-btn{display:flex;flex-direction:column;align-items:center;gap:8px;padding:10px}
  .flag-img{width:100%;max-width:140px;height:auto;border:1px solid var(--border);border-radius:8px;box-shadow:0 1px 0 rgba(0,0,0,.04);background:#fff}
  .flag-label{font-size:12px;color:var(--muted);text-align:center}

  dialog{border:none;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:0;max-width:720px;width:min(92vw,720px)}
  .dlg-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);background:var(--card)}
  .dlg-body{padding:10px 16px 16px;background:var(--card);max-height:min(70vh,580px);overflow:auto}
  .list{display:flex;flex-direction:column;gap:10px}
  .row{border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#fff}
  .row h4{margin:0 0 6px;font-size:15px}
  .row p{margin:0;font-size:14px}
  .row .mine{color:var(--bad)}
  .row .correct{color:var(--ok)}
  .row button.jump{margin-top:8px}

  /* Default highlight (current question): blue fill + dark outline with a slight nudge */
  .hl, .hl * { fill: var(--mapHl) !important; stroke: var(--mapHlStroke) !important; stroke-width:4 !important; }
  .hl-anim, .hl-anim * { transform-box: fill-box; transform-origin: center; animation: nudge .45s ease-out; }
  @keyframes nudge { 0%{transform:translate(0,0) scale(1)} 35%{transform:translate(0,-4px) scale(1.02)} 100%{transform:translate(0,0) scale(1)} }

  /* Easy-mode feedback: correct = green, wrong = red */
  .hl-correct, .hl-correct * { fill:#d1fae5 !important; stroke:#065f46 !important; stroke-width:4 !important; }
  .hl-wrong,   .hl-wrong *   { fill:#fee2e2 !important; stroke:#991b1b !important; stroke-width:4 !important; }

  .flag-wrap{margin-top:8px;display:flex;align-items:center;gap:10px}
  .flag-wrap img{max-width:160px;width:100%;height:auto;border:1px solid var(--border);border-radius:8px;box-shadow:0 1px 0 rgba(0,0,0,.04)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Europe Countries, Capitals & Flags Trainer</h1>
      <div class="controls">
        <select id="mode" class="sel" title="Choose mode">
          <option value="easy">Easy — find the highlighted country</option>
          <option value="intermediate">Intermediate — pick the capital</option>
          <option value="hard">Hard — type the capital</option>
          <option value="flag">Flag — pick the country’s flag</option>
        </select>
        <span class="pill" id="scorePill">Score: 0/0 0%</span>
        <span class="pill">Question <strong id="qnum">0</strong>/<span id="qcount">0</span></span>
        <span class="pill badge hide" id="deckBadge">Wrong-only mode</span>
        <button class="btn" id="wrongBtn" disabled>Wrong (0)</button>
        <button class="btn" id="retakeWrongBtn" disabled>Retake Wrong Only</button>
        <button class="btn" id="shuffleBtn">Shuffle</button>
        <button class="btn" id="restartBtn">Restart</button>
      </div>
    </header>

    <div class="progress"><div class="bar" id="bar"></div></div>

    <div class="grid">
      <div class="card">
        <div class="meta">Map</div>
        <div class="mapbox" id="mapbox">
          <div class="map-status small" id="mapStatus">Loading SVG map…</div>
        </div>
      </div>

      <div class="card">
        <div class="meta" id="meta">Pick the correct answer.</div>
        <p class="q" id="question">Loading…</p>

        <div class="choices" id="choices"></div>

        <div id="freeRow" class="answer-row hide" style="margin-top:8px">
          <input type="text" id="freeInput" placeholder="Type the capital…" autocomplete="off" />
          <button class="btn primary" id="checkBtn">Check</button>
        </div>

        <div id="feedback" class="feedback hide"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:8px;flex-wrap:wrap">
          <div class="small" id="hintArea"></div>
          <div>
            <button class="btn" id="prevBtn">Prev</button>
            <button class="btn primary" id="nextBtn">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Options -->
    <details style="margin-top:14px">
      <summary>⚙️ Options</summary>
      <div class="card" style="margin-top:10px;display:grid;gap:12px">
        <div>
          <div class="small" style="margin-bottom:6px">Multiple-choice answers per question</div>
          <select id="choiceCountSel" class="sel" title="Number of choices">
            <option value="5">5</option>
            <option value="6" selected>6 (default)</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
          </select>
          <p class="small" style="margin-top:8px">
            Applies to <strong>Easy</strong>, <strong>Intermediate</strong>, and <strong>Flag</strong>. Keyboard shortcuts adapt to the chosen count (1–9).
          </p>
        </div>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="revealCapitalChk" />
          <span>Show capital after answering in <strong>Easy</strong> mode</span>
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="showFlagChk" />
          <span>Show national flag after answering (all modes except Flag, where flags are the choices)</span>
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="hideFlagLabelsChk" />
          <span>Hide country names under flags (Flag mode)</span>
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="hideFlagQuestionChk" />
          <span>Hide country name in question (Flag mode)</span>
        </label>

        <p class="small" style="margin:0">Flags from Wikipedia’s “Flags of Europe”.</p>
      </div>
    </details>

    <details style="margin-top:14px">
      <summary>ℹ️ Notes for teachers/parents</summary>
      <ul class="small" style="margin-top:6px">
        <li>Modes: <strong>Easy</strong> (highlighted country → pick country), <strong>Intermediate</strong> (country → pick capital), <strong>Hard</strong> (type the capital), <strong>Flag</strong> (pick the correct flag).</li>
        <li>Score is shown as <em>correct / answered</em> with whole-number percent.</li>
        <li><strong>Wrong (n)</strong> shows missed questions; <strong>Retake Wrong Only</strong> makes a mini-deck from them.</li>
        <li>Keyboard: press <strong>1…N</strong> to choose in MCQ; press <strong>Enter</strong> in Hard mode.</li>
      </ul>
    </details>
  </div>

  <!-- Wrong review dialog -->
  <dialog id="wrongDlg">
    <div class="dlg-head">
      <strong>Review: Wrong Answers</strong>
      <button class="btn" id="closeWrong">Close</button>
    </div>
    <div class="dlg-body">
      <div id="wrongList" class="list"></div>
    </div>
  </dialog>

<script>
/* --------------------------------------------
   Polyfills & helpers (iOS/Safari)
---------------------------------------------*/
if (typeof CSS === "undefined") { window.CSS = {}; }
if (typeof CSS.escape !== "function") {
  CSS.escape = function(value) {
    const str = String(value); const length = str.length; let result = "";
    for (let i=0;i<length;i++){ const codeUnit=str.charCodeAt(i);
      if(codeUnit===0x0000){ result+="\uFFFD"; continue; }
      if((codeUnit>=0x0001 && codeUnit<=0x001F) || codeUnit===0x007F ||
         (i===0 && codeUnit>=0x0030 && codeUnit<=0x0039) ||
         (i===1 && codeUnit>=0x0030 && codeUnit<=0x0039 && str.charCodeAt(0)===0x002D)) {
        result += "\\" + codeUnit.toString(16) + " "; continue;
      }
      if(codeUnit>=0x0080 || codeUnit===0x002D || codeUnit===0x005F ||
         (codeUnit>=0x0030 && codeUnit<=0x0039) ||
         (codeUnit>=0x0041 && codeUnit<=0x005A) ||
         (codeUnit>=0x0061 && codeUnit<=0x007A)) { result += str.charAt(i); continue; }
      result += "\\" + str.charAt(i);
    } return result;
  };
}

/* --------------------------------------------
   Data: European countries, capitals, regions, and in-country city decoys
---------------------------------------------*/
const COUNTRIES = [
  // Northern
  {code:"IS",name:"Iceland",capital:"Reykjavík",region:"Northern",cities:["Kópavogur","Hafnarfjörður","Akureyri"]},
  {code:"NO",name:"Norway",capital:"Oslo",region:"Northern",cities:["Bergen","Trondheim","Stavanger"]},
  {code:"SE",name:"Sweden",capital:"Stockholm",region:"Northern",cities:["Gothenburg","Malmö","Uppsala"]},
  {code:"FI",name:"Finland",capital:"Helsinki",region:"Northern",cities:["Espoo","Tampere","Turku"]},
  {code:"DK",name:"Denmark",capital:"Copenhagen",region:"Northern",cities:["Aarhus","Odense","Aalborg"]},
  {code:"EE",name:"Estonia",capital:"Tallinn",region:"Northern",cities:["Tartu","Narva","Pärnu"]},
  {code:"LV",name:"Latvia",capital:"Riga",region:"Northern",cities:["Daugavpils","Liepāja","Jelgava"]},
  {code:"LT",name:"Lithuania",capital:"Vilnius",region:"Northern",cities:["Kaunas","Klaipėda","Šiauliai"]},
  {code:"IE",name:"Ireland",capital:"Dublin",region:"Northern",cities:["Cork","Limerick","Galway"]},
  {code:"GB",name:"United Kingdom",capital:"London",region:"Northern",cities:["Birmingham","Manchester","Leeds","Glasgow"]},

  // Western
  {code:"FR",name:"France",capital:"Paris",region:"Western",cities:["Marseille","Lyon","Toulouse","Nice"]},
  {code:"DE",name:"Germany",capital:"Berlin",region:"Western",cities:["Hamburg","Munich","Cologne","Frankfurt"]},
  {code:"BE",name:"Belgium",capital:"Brussels",region:"Western",cities:["Antwerp","Ghent","Charleroi"]},
  {code:"NL",name:"Netherlands",capital:"Amsterdam",region:"Western",cities:["Rotterdam","The Hague","Utrecht"]},
  {code:"LU",name:"Luxembourg",capital:"Luxembourg",region:"Western",cities:["Esch-sur-Alzette","Differdange"]},
  {code:"AT",name:"Austria",capital:"Vienna",region:"Western",cities:["Graz","Linz","Salzburg"]},
  {code:"LI",name:"Liechtenstein",capital:"Vaduz",region:"Western",cities:["Schaan","Balzers","Eschen"]},
  {code:"CH",name:"Switzerland",capital:"Bern",region:"Western",cities:["Zurich","Geneva","Basel","Lausanne"]},
  {code:"MC",name:"Monaco",capital:"Monaco",region:"Western",cities:["Monte Carlo","La Condamine"]},

  // Southern
  {code:"PT",name:"Portugal",capital:"Lisbon",region:"Southern",cities:["Porto","Vila Nova de Gaia","Coimbra"]},
  {code:"ES",name:"Spain",capital:"Madrid",region:"Southern",cities:["Barcelona","Valencia","Seville","Zaragoza"]},
  {code:"IT",name:"Italy",capital:"Rome",region:"Southern",cities:["Milan","Naples","Turin","Palermo"]},
  {code:"SM",name:"San Marino",capital:"San Marino",region:"Southern",cities:["Serravalle","Borgo Maggiore","Domagnano"]},
  {code:"VA",name:"Vatican City",capital:"Vatican City",region:"Southern",cities:["—"]},
  {code:"MT",name:"Malta",capital:"Valletta",region:"Southern",cities:["Birkirkara","Mosta","Sliema"]},
  {code:"GR",name:"Greece",capital:"Athens",region:"Southern",cities:["Thessaloniki","Patras","Heraklion"]},
  {code:"CY",name:"Cyprus",capital:"Nicosia",region:"Southern",cities:["Limassol","Larnaca","Paphos"]},
  {code:"AD",name:"Andorra",capital:"Andorra la Vella",region:"Southern",cities:["Escaldes-Engordany","Encamp","La Massana"]},

  // Eastern
  {code:"PL",name:"Poland",capital:"Warsaw",region:"Eastern",cities:["Kraków","Łódź","Wrocław","Gdańsk"]},
  {code:"CZ",name:"Czechia",capital:"Prague",region:"Eastern",cities:["Brno","Ostrava","Plzeň"]},
  {code:"SK",name:"Slovakia",capital:"Bratislava",region:"Eastern",cities:["Košice","Prešov","Žilina"]},
  {code:"HU",name:"Hungary",capital:"Budapest",region:"Eastern",cities:["Debrecen","Szeged","Miskolc"]},
  {code:"SI",name:"Slovenia",capital:"Ljubljana",region:"Eastern",cities:["Maribor","Celje","Kranj"]},
  {code:"HR",name:"Croatia",capital:"Zagreb",region:"Eastern",cities:["Split","Rijeka","Osijek"]},
  {code:"BA",name:"Bosnia and Herzegovina",capital:"Sarajevo",region:"Eastern",cities:["Banja Luka","Mostar","Tuzla"]},
  {code:"RS",name:"Serbia",capital:"Belgrade",region:"Eastern",cities:["Novi Sad","Niš","Kragujevac"]},
  {code:"ME",name:"Montenegro",capital:"Podgorica",region:"Eastern",cities:["Nikšić","Herceg Novi","Pljevlja"]},
  {code:"MK",name:"North Macedonia",capital:"Skopje",region:"Eastern",cities:["Bitola","Kumanovo","Prilep"]},
  {code:"AL",name:"Albania",capital:"Tirana",region:"Eastern",cities:["Durrës","Vlorë","Shkodër"]},
  {code:"BG",name:"Bulgaria",capital:"Sofia",region:"Eastern",cities:["Plovdiv","Varna","Burgas"]},
  {code:"RO",name:"Romania",capital:"Bucharest",region:"Eastern",cities:["Cluj-Napoca","Timișoara","Iași","Constanța"]},
  {code:"MD",name:"Moldova",capital:"Chișinău",region:"Eastern",cities:["Bălți","Tiraspol","Bender"]},
  {code:"UA",name:"Ukraine",capital:"Kyiv",region:"Eastern",cities:["Kharkiv","Odesa","Dnipro","Lviv"]},
  {code:"BY",name:"Belarus",capital:"Minsk",region:"Eastern",cities:["Gomel","Mogilev","Vitebsk"]},
  {code:"RU",name:"Russia",capital:"Moscow",region:"Eastern",cities:["Saint Petersburg","Novosibirsk","Yekaterinburg"]}
];

// Clean list
const COUNTRIES_CLEAN = COUNTRIES.filter(c=>c && c.name && c.capital);

// ISO-2 -> ISO-3 mapping
const ISO3 = {
  AL:"ALB", AD:"AND", AT:"AUT", BA:"BIH", BE:"BEL", BG:"BGR", BY:"BLR",
  CH:"CHE", CY:"CYP", CZ:"CZE", DE:"DEU", DK:"DNK", EE:"EST", ES:"ESP",
  FI:"FIN", FR:"FRA", GB:"GBR", GR:"GRC", HR:"HRV", HU:"HUN", IE:"IRL",
  IS:"ISL", IT:"ITA", LI:"LIE", LT:"LTU", LU:"LUX", LV:"LVA", MC:"MCO",
  MD:"MDA", ME:"MNE", MK:"MKD", MT:"MLT", NL:"NLD", NO:"NOR", PL:"POL",
  PT:"PRT", RO:"ROU", RS:"SRB", RU:"RUS", SE:"SWE", SI:"SVN", SK:"SVK",
  SM:"SMR", UA:"UKR", VA:"VAT"
};
COUNTRIES_CLEAN.forEach(c => { c.iso3 = ISO3[c.code] || null; });

const byCode = Object.fromEntries(COUNTRIES_CLEAN.map(s=>[s.code,s]));
const capitalNames = COUNTRIES_CLEAN.map(s=>s.capital);

// Flag filename exceptions
const FLAG_EXCEPTIONS = new Map([
  ["Czechia","Flag of the Czech Republic.svg"],
  ["United Kingdom","Flag of the United Kingdom.svg"],
  ["North Macedonia","Flag of North Macedonia.svg"],
  ["Bosnia and Herzegovina","Flag of Bosnia and Herzegovina.svg"],
  ["Moldova","Flag of Moldova.svg"],
  ["Russia","Flag of Russia.svg"],
  ["Cyprus","Flag of Cyprus.svg"],
  ["Vatican City","Flag of the Vatican City.svg"],
  ["San Marino","Flag of San Marino.svg"]
]);
function flagFileName(countryName){ return FLAG_EXCEPTIONS.get(countryName) || `Flag of ${countryName}.svg`; }
function flagUrl(countryName, width=360){
  return `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(flagFileName(countryName))}?width=${width}`;
}

/* --------------------------------------------
   UI refs
---------------------------------------------*/
const modeSel = document.getElementById('mode');
const choiceCountSel = document.getElementById('choiceCountSel');
const revealCapitalChk = document.getElementById('revealCapitalChk');
const showFlagChk = document.getElementById('showFlagChk');
const hideFlagLabelsChk = document.getElementById('hideFlagLabelsChk');
const hideFlagQuestionChk = document.getElementById('hideFlagQuestionChk');
const scorePill = document.getElementById('scorePill');
const qnumEl = document.getElementById('qnum');
const qcountEl = document.getElementById('qcount');
const deckBadge = document.getElementById('deckBadge');
const barEl = document.getElementById('bar');

const mapbox = document.getElementById('mapbox');
const mapStatus = document.getElementById('mapStatus');

const metaEl = document.getElementById('meta');
const questionEl = document.getElementById('question');
const choicesEl = document.getElementById('choices');
const freeRow = document.getElementById('freeRow');
const freeInput = document.getElementById('freeInput');
const checkBtn = document.getElementById('checkBtn');
const feedbackEl = document.getElementById('feedback');
const hintArea = document.getElementById('hintArea');

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const wrongBtn = document.getElementById('wrongBtn');
const retakeWrongBtn = document.getElementById('retakeWrongBtn');

const wrongDlg = document.getElementById('wrongDlg');
const wrongList = document.getElementById('wrongList');
const closeWrong = document.getElementById('closeWrong');

/* --------------------------------------------
   Engine state
---------------------------------------------*/
let deck = [];
let idx = 0;
let score = 0;
let answered = new Map();
let wrongOnly = false;

let svgRoot = null;
let currentHighlight = null;
let highlightedNodes = [];
let svgObjectEl = null;

/* Options persisted */
let MCQ_CHOICES = clamp(parseInt(localStorage.getItem('eu_mcq_choices') || '6',10),5,9);
let REVEAL_CAPITAL = localStorage.getItem('eu_reveal_capital') === '1';
let SHOW_FLAG = localStorage.getItem('eu_show_flag') === '1';
let HIDE_FLAG_LABELS = localStorage.getItem('eu_hide_flag_labels') === '1';
let HIDE_FLAG_QUESTION = localStorage.getItem('eu_hide_flag_question') === '1';

/* --------------------------------------------
   Utils
---------------------------------------------*/
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function answeredCount(){ return answered.size; }
function wrongCodes(){ return [...answered.entries()].filter(([c,res])=>!res.correct).map(([c])=>c); }
function percent(){ const a=answeredCount(); return a? Math.floor((score/a)*100) : 0; }
function setBadge(){ deckBadge.classList.toggle('hide', !wrongOnly); }
function normalize(s){ return s.normalize('NFD').replace(/\p{Diacritic}/gu,'').trim().toLowerCase().replace(/\s+/g,' '); }
function updateHeader(){
  scorePill.textContent = `Score: ${score}/${answeredCount()} ${percent()}%`;
  qcountEl.textContent = deck.length;
  qnumEl.textContent = Math.min(idx+1, deck.length);
  barEl.style.width = `${Math.round((idx)/Math.max(deck.length,1)*100)}%`;
  const w = wrongCodes().length;
  wrongBtn.textContent = `Wrong (${w})`;
  wrongBtn.disabled = w===0;
  retakeWrongBtn.disabled = w===0;
  setBadge();
}
function gridClassForChoices(n){
  if(n>=9) return 'choices cols-9';
  if(n>=8) return 'choices cols-8';
  return 'choices cols-6';
}

/* Deck sanitizer to avoid undefined codes */
function sanitizeDeck() {
  deck = (Array.isArray(deck) ? deck : []).filter(c => typeof c === 'string' && !!byCode[c]);
  if (deck.length === 0) deck = shuffle(COUNTRIES_CLEAN.map(s => s.code));
  idx = clamp(idx, 0, Math.max(deck.length - 1, 0));
}

/* --------------------------------------------
   Map loading (Europe) — Safari/Chrome & CORS-safe
---------------------------------------------*/
const SVG_URLS = [
  "./maps/Europe.svg", // local same-origin (best)
  "https://upload.wikimedia.org/wikipedia/commons/6/66/Blank_map_of_Europe_cropped.svg"
];

function sameOrigin(u){
  try{ const url = new URL(u, location.href); return url.origin === location.origin; }
  catch{ return false; }
}

async function loadSvgFromUrl(){
  let lastErr = null;
  for (const url of SVG_URLS){
    try{
      console.log("[map] Fetching SVG from", url);

      if (sameOrigin(url)) {
        const okObj = await tryObjectEmbedURL(url);
        if (okObj){ mapStatus.textContent = "Map loaded ✅"; setTimeout(()=>mapStatus.classList.add('hide'), 800); return; }
        throw new Error("Same-origin <object> render failed");
      }

      const res = await fetch(url, { mode:'cors', cache:'no-store', headers:{ 'Accept':'image/svg+xml,*/*;q=0.8' }});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();

      const okInline = await tryInlineInject(text);
      if(okInline){ mapStatus.textContent = "Map loaded ✅"; setTimeout(()=>mapStatus.classList.add('hide'), 800); return; }

      throw new Error("Rendered 0 countries via inline (likely id mismatch)");
    } catch(e){
      console.warn("[map] Load/render failed for url:", url, e);
      lastErr = e;
    }
  }
  mapStatus.textContent = "Couldn’t load map.";
  console.warn("[map] All attempts failed", lastErr);
}

async function tryObjectEmbedURL(url){
  clearSvg();
  const obj = document.createElement('object');
  obj.type = 'image/svg+xml';
  obj.data = url; // same-origin => contentDocument available
  obj.id = 'eu-map-object';
  obj.style.width = '100%';
  obj.style.display = 'block';
  obj.style.minHeight = '320px';
  svgObjectEl = obj;
  mapbox.appendChild(obj);

  const loaded = await new Promise(resolve=>{
    const to = setTimeout(()=>resolve(false), 7000);
    obj.addEventListener('load', ()=>{ clearTimeout(to); resolve(true); });
    obj.addEventListener('error', ()=>{ clearTimeout(to); resolve(false); });
  });
  if(!loaded){ console.warn('[map] <object> failed to load'); return false; }

  const doc = obj.contentDocument; if(!doc){ console.warn('[map] No contentDocument'); return false; }
  const svg = doc.documentElement; if(!svg || svg.nodeName.toLowerCase()!=='svg'){ console.warn('[map] contentDocument not SVG'); return false; }
  svgRoot = svg;

  svgRoot.querySelectorAll('title').forEach(t=>t.remove());
  indexCountries(svgRoot);

  let found=0; COUNTRIES_CLEAN.forEach(s=>{ const nodes=findCountryNodes(s.code,s.name); if(nodes.length) found++; });
  console.log(`[map] Object resolved countries: ${found}/${COUNTRIES_CLEAN.length}`);
  attachMapClick();
  injectHighlightStylesIntoObject();

  setObjectHeightFromViewBox();
  if(resizeHandler) window.removeEventListener('resize', resizeHandler);
  resizeHandler = ()=>setObjectHeightFromViewBox();
  window.addEventListener('resize', resizeHandler);

  return found >= 25;
}

async function tryInlineInject(svgText){
  clearSvg();
  let svg=null;
  try{
    const parser = new DOMParser();
    const doc = parser.parseFromString(svgText, 'image/svg+xml');
    if (doc.getElementsByTagName('parsererror').length) throw new Error('parsererror');
    svg = doc.documentElement;
  } catch(e){ console.warn("[map] DOMParser failed:", e); return false; }

  if(svg.ownerDocument !== document) svg = document.importNode(svg, true);
  svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
  svg.setAttribute('xmlns:xlink','http://www.w3.org/1999/xlink');
  svg.removeAttribute('width'); svg.removeAttribute('height');
  svg.setAttribute('id','eu-map-inline');
  mapbox.appendChild(svg);

  if(!svg.getAttribute('viewBox')){
    try{ await new Promise(r=>requestAnimationFrame(()=>r())); const bbox = svg.getBBox();
      svg.setAttribute('viewBox', `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
    }catch{ svg.setAttribute('viewBox','0 0 959 593'); }
  }
  svg.setAttribute('preserveAspectRatio','xMidYMid meet');
  svg.style.height='auto';

  svgRoot = svg;
  indexCountries(svgRoot);
  svgRoot.querySelectorAll('title').forEach(t=>t.remove());

  let found=0; COUNTRIES_CLEAN.forEach(s=>{ const nodes=findCountryNodes(s.code,s.name); if(nodes.length) found++; });
  console.log(`[map] Inline resolved countries: ${found}/${COUNTRIES_CLEAN.length}`);
  attachMapClick();
  return found >= 25;
}

let resizeHandler = null;
function setObjectHeightFromViewBox(){
  if(!svgObjectEl || !svgObjectEl.contentDocument) return;
  const innerSvg = svgObjectEl.contentDocument.documentElement;
  if(!innerSvg) return;
  let vw=959, vh=593;
  const vb = innerSvg.getAttribute('viewBox');
  if(vb){
    const parts = vb.trim().split(/\s+/).map(Number);
    if(parts.length===4 && parts.every(n=>!isNaN(n))){
      vw = parts[2]; vh = parts[3];
    }
  }
  const ratio = vh / vw;
  const width = mapbox.clientWidth || svgObjectEl.clientWidth || 800;
  const height = Math.max(320, Math.round(width * ratio));
  svgObjectEl.style.height = height + 'px';
}

/* Inject highlight styles into <defs> (no doc.head reliance) */
function injectHighlightStylesIntoObject(){
  if(!svgObjectEl || !svgObjectEl.contentDocument) return;

  const doc = svgObjectEl.contentDocument;
  const root = doc.documentElement; // <svg>
  if (!root || root.nodeName.toLowerCase() !== 'svg') return;

  if (root.querySelector('style[data-eu-hl]')) return;

  const cs = getComputedStyle(document.documentElement);
  const mapHl = (cs.getPropertyValue('--mapHl').trim() || '#bfdbfe');
  const mapHlStroke = (cs.getPropertyValue('--mapHlStroke').trim() || '#1e3a8a');

  const cssText = `
    .hl, .hl * { fill: ${mapHl} !important; stroke: ${mapHlStroke} !important; stroke-width:4 !important; }
    .hl-anim, .hl-anim * { transform-box: fill-box; transform-origin: center; animation: nudge .45s ease-out; }
    @keyframes nudge { 0%{transform:translate(0,0) scale(1)} 35%{transform:translate(0,-4px) scale(1.02)} 100%{transform:translate(0,0) scale(1)} }
    .hl-correct, .hl-correct * { fill:#d1fae5 !important; stroke:#065f46 !important; stroke-width:4 !important; }
    .hl-wrong,   .hl-wrong *   { fill:#fee2e2 !important; stroke:#991b1b !important; stroke-width:4 !important; }
  `;

  const styleEl = doc.createElementNS('http://www.w3.org/2000/svg', 'style');
  styleEl.setAttribute('type', 'text/css');
  styleEl.setAttribute('data-eu-hl', '1');
  styleEl.textContent = cssText;

  let defs = root.querySelector('defs');
  if (!defs) {
    defs = doc.createElementNS('http://www.w3.org/2000/svg', 'defs');
    if (root.firstChild) root.insertBefore(defs, root.firstChild);
    else root.appendChild(defs);
  }
  defs.appendChild(styleEl);
}

function clearSvg(){
  if(resizeHandler){ window.removeEventListener('resize', resizeHandler); resizeHandler=null; }
  svgRoot = null; currentHighlight = null; highlightedNodes = []; svgObjectEl = null;
  [...mapbox.querySelectorAll('svg,object')].forEach(n=>n.remove());
}

/* --------------------------------------------
   Map indexing & highlighting (robust)
---------------------------------------------*/
function indexCountries(rootSvg){
  const byName = new Map(COUNTRIES_CLEAN.map(s=>[s.name.toLowerCase(), s]));
  function tag(el, ct){ if(!el) return; try{ el.setAttribute('data-code', ct.code); el.setAttribute('data-name', ct.name); }catch{} }

  // 1) Direct id patterns
  COUNTRIES_CLEAN.forEach(ct=>{
    const iso2 = ct.code;
    const iso3 = ct.iso3;
    const ids = [
      `#${iso2}`, `#${iso2.toLowerCase()}`,
      `#EU-${iso2}`, `#eu-${iso2.toLowerCase()}`,
      `#iso-${iso2.toLowerCase()}`, `#iso-a2-${iso2.toLowerCase()}`,
      ...(iso3 ? [
        `#${iso3}`, `#${iso3.toLowerCase()}`,
        `#EU-${iso3}`, `#eu-${iso3.toLowerCase()}`,
        `#iso-${iso3.toLowerCase()}`, `#iso-a3-${iso3.toLowerCase()}`
      ] : []),
      `#${ct.name.replace(/\s+/g,'_')}`
    ];
    for(const sel of ids){ try{ const el = rootSvg.querySelector(sel); if(el){ tag(el, ct); return; } }catch{} }
  });

  // 2) Attribute-based & fuzzy
  rootSvg.querySelectorAll('[data-iso],[data-iso2],[data-iso3],[data-name],[name],[title],[inkscape\\:label],[id],[class]').forEach(el=>{
    const attrs = [
      el.getAttribute('data-iso'), el.getAttribute('data-iso2'), el.getAttribute('data-iso3'),
      el.getAttribute('data-name'), el.getAttribute('name'), el.getAttribute('title'),
      el.getAttribute('inkscape:label'), el.id, el.getAttribute('class')
    ].filter(Boolean);
    if(!attrs.length) return;

    const big = attrs.join(' ').toLowerCase();

    for (const [nm, ct] of byName.entries()){
      if (big.includes(nm)) { tag(el, ct); return; }
    }
    for (const ct of COUNTRIES_CLEAN){
      const c2 = ct.code.toLowerCase(), c3 = (ct.iso3||'').toLowerCase();
      if (c2 && big.match(new RegExp(`\\b${c2}\\b`))) { tag(el, ct); return; }
      if (c3 && big.match(new RegExp(`\\b${c3}\\b`))) { tag(el, ct); return; }
      if (big.includes(ct.name.toLowerCase().replace(/\s+/g,'_'))) { tag(el, ct); return; }
    }
  });

  // 3) Titles to parent
  rootSvg.querySelectorAll('title').forEach(t=>{
    const nm=(t.textContent||'').trim().toLowerCase();
    const ct=byName.get(nm);
    if(ct) tag(t.parentElement, ct);
  });
}

function findCountryNodes(code, name){
  if(!svgRoot) return [];
  const results = new Set();
  const safe = s => CSS.escape(s);
  const iso3 = ISO3[code];

  const tryQ = sel => { try{ const el = svgRoot.querySelector(sel); if(el) results.add(el); }catch{} };

  // ISO-2 variants
  tryQ(`#${safe(code)}`);
  tryQ(`#${safe(code.toLowerCase())}`);
  tryQ(`#EU-${safe(code)}`);
  tryQ(`#eu-${safe(code.toLowerCase())}`);
  tryQ(`#iso-${safe(code.toLowerCase())}`);
  tryQ(`#iso-a2-${safe(code.toLowerCase())}`);

  // ISO-3 variants
  if (iso3){
    tryQ(`#${safe(iso3)}`);
    tryQ(`#${safe(iso3.toLowerCase())}`);
    tryQ(`#EU-${safe(iso3)}`);
    tryQ(`#eu-${safe(iso3.toLowerCase())}`);
    tryQ(`#iso-${safe(iso3.toLowerCase())}`);
    tryQ(`#iso-a3-${safe(iso3.toLowerCase())}`);
  }

  // Name-based id like "United_Kingdom"
  tryQ(`#${safe(name.replace(/\s+/g,'_'))}`);

  // Attribute-driven matches added by indexer
  if(svgRoot.querySelectorAll){
    svgRoot.querySelectorAll(`[data-code="${code}"]`).forEach(el=>results.add(el));
    svgRoot.querySelectorAll(`[data-name="${name.replace(/"/g,'\\"')}"]`).forEach(el=>results.add(el));
    svgRoot.querySelectorAll(`[inkscape\\:label="${name.replace(/"/g,'\\"')}"]`).forEach(el=>results.add(el));
  }

  // Fuzzy: any element whose id/class contains code/iso3/name slug
  if (results.size === 0 && svgRoot.querySelectorAll){
    const slug = name.toLowerCase().replace(/\s+/g,'_');
    const c2 = code.toLowerCase(), c3 = (iso3||'').toLowerCase();
    svgRoot.querySelectorAll('[id],[class]').forEach(el=>{
      const blob = ((el.id||'')+' '+(el.getAttribute('class')||'')).toLowerCase();
      if (blob.includes(slug) || (c2 && blob.includes(c2)) || (c3 && blob.includes(c3))) results.add(el);
    });
  }

  return [...results];
}

function clearHighlight(){
  if(!svgRoot) return;
  if(svgRoot.querySelectorAll){
    svgRoot.querySelectorAll('.hl, .hl-correct, .hl-wrong')
      .forEach(n=>n.classList.remove('hl','hl-anim','hl-correct','hl-wrong'));
  }
  highlightedNodes = []; currentHighlight = null;
}
function highlightCountry(code){
  const ct = byCode[code];
  if (!ct) {
    console.warn(`[map] highlight: Unknown code ${code}`);
    return;
  }
  clearHighlight();
  const nodes = findCountryNodes(code, ct.name);
  if(!nodes.length){ console.warn(`[map] highlight: No nodes found for ${code} (${ct.name})`); return; }
  nodes.forEach(el=>{ try{
    el.classList.add('hl','hl-anim');
    if(el.querySelectorAll) el.querySelectorAll('*').forEach(ch=>ch.classList.add('hl','hl-anim'));
  }catch{} });
  highlightedNodes = nodes; currentHighlight = code;
  console.log(`[map] highlight: ${code} (${ct.name}) — highlighted ${nodes.length} node(s)`);
}

// Disable auto-submit on map click in Easy
function attachMapClick(){
  if(!svgRoot) return;

  if(svgObjectEl && svgObjectEl.contentDocument){
    const svg = svgObjectEl.contentDocument.documentElement;
    svg.addEventListener('click', e=>{
      if(!currentHighlight || modeSel.value!=='easy') return;
      const inside = highlightedNodes.some(n => n.contains(e.target) || n === e.target);
      if(inside){ console.log('[map] easy-mode map clicks disabled'); }
    }, {passive:true});
    return;
  }
  const clone = svgRoot.cloneNode(true);
  svgRoot.replaceWith(clone);
  svgRoot = clone;
  svgRoot.addEventListener('click', e=>{
    if(!currentHighlight || modeSel.value!=='easy') return;
    const inside = highlightedNodes.some(n => n.contains(e.target) || n === e.target);
    if(inside){ console.log('[map] easy-mode map clicks disabled'); }
  }, {passive:true});
}

/* --------------------------------------------
   Deck / Flags / Feedback / Choices
---------------------------------------------*/
function makeFullDeck(){
  deck = shuffle(COUNTRIES_CLEAN.map(s=>s.code));
  idx = 0; score = 0; answered.clear(); wrongOnly = false;
  sanitizeDeck();
  updateHeader();
}
function makeWrongOnlyDeck(){
  const wrong = wrongCodes();
  if (!wrong.length) return;
  deck = shuffle([...wrong]);
  idx = 0; score = 0; answered.clear(); wrongOnly = true;
  sanitizeDeck();
  updateHeader();
}
function nextQuestion(){
  sanitizeDeck();
  if(idx < deck.length-1){
    idx++;
    render();
  } else {
    questionEl.textContent = `Done! Score: ${score}/${answeredCount()} ${percent()}%.`;
    metaEl.textContent = wrongOnly ? 'Wrong-only mini-quiz complete.' : 'Quiz complete.';
    choicesEl.innerHTML = ''; freeRow.classList.add('hide'); feedbackEl.textContent = ''; feedbackEl.classList.add('hide');
    clearHighlight(); prevBtn.disabled = false; nextBtn.disabled = true; updateHeader();
  }
}
function prevQuestion(){
  sanitizeDeck();
  if(idx>0){ idx--; render(); }
}

function buildExtraInfo(countryObj, mode){
  const lines = [];
  if(mode==='easy' && REVEAL_CAPITAL) lines.push(`<div class="small">Capital: ${countryObj.capital}</div>`);
  if(SHOW_FLAG && mode!=='flag') lines.push(`<div class="flag-wrap"><img src="${flagUrl(countryObj.name,160)}" alt="Flag of ${countryObj.name}" loading="lazy"></div>`);
  return lines.join("");
}

/* --------------------------------------------
   Render per mode (incl. Flag mode)
---------------------------------------------*/
function render(){
  sanitizeDeck();

  if (deck.length === 0) {
    questionEl.textContent = 'No questions available.';
    choicesEl.innerHTML = '';
    feedbackEl.classList.add('hide');
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    updateHeader();
    return;
  }

  updateHeader();

  let code = deck[idx];
  let ct = byCode[code];

  if (!ct) {
    console.warn('[render] Invalid deck entry:', code, '— removing and retrying');
    deck.splice(idx, 1);
    if (idx >= deck.length) idx = Math.max(deck.length - 1, 0);
    render();
    return;
  }

  const mode = modeSel.value;

  feedbackEl.textContent=''; feedbackEl.classList.add('hide');
  choicesEl.innerHTML=''; hintArea.textContent='';
  freeRow.classList.add('hide'); freeInput.value=''; freeInput.disabled=false; checkBtn.disabled=false;

  highlightCountry(code);

  if(mode==='easy'){
    metaEl.textContent = `Which country is highlighted on the map? (${MCQ_CHOICES} choices)`;
    questionEl.textContent = 'Select the correct country:';
    const opts = buildCountryChoicesWithRegionalDecoys(ct, MCQ_CHOICES);
    choicesEl.className = gridClassForChoices(MCQ_CHOICES);
    renderChoices(opts, ct.name);
    const was = answered.get(code); if(was){ showFeedback(was.correct, ct.name, buildExtraInfo(ct,'easy')); }
  } else if(mode==='intermediate'){
    metaEl.textContent = `Pick the correct capital (${MCQ_CHOICES} choices).`;
    questionEl.textContent = `What is the capital of ${ct.name}?`;
    const opts = buildCapitalChoicesWithDecoys(ct, MCQ_CHOICES);
    choicesEl.className = gridClassForChoices(MCQ_CHOICES);
    renderChoices(opts, ct.capital);
    const was = answered.get(code); if(was){ showFeedback(was.correct, ct.capital, buildExtraInfo(ct,'intermediate')); }
  } else if(mode==='flag'){
    metaEl.textContent = `Pick the correct flag (${MCQ_CHOICES} choices).`;
    questionEl.textContent = HIDE_FLAG_QUESTION ? 'Select the correct flag:' : `Which flag belongs to ${ct.name}?`;
    const opts = buildFlagChoices(ct, MCQ_CHOICES); // array of country names
    choicesEl.className = gridClassForChoices(MCQ_CHOICES);
    renderFlagChoices(opts, ct.name);
    const was = answered.get(code); if(was){ showFeedback(was.correct, ct.name, buildExtraInfo(ct,'flag')); }
  } else {
    metaEl.textContent = 'Type the correct capital (press Enter or click Check).';
    questionEl.textContent = `What is the capital of ${ct.name}?`;
    freeRow.classList.remove('hide'); freeInput.focus();
    checkBtn.onclick = ()=>{
      const pickRaw = freeInput.value; if(!pickRaw.trim()) return;
      const ok = normalize(pickRaw) === normalize(ct.capital);
      registerAnswer(code, ok, pickRaw, ct.capital);
    };
    const was = answered.get(code);
    if(was){ freeInput.value = was.pick||''; freeInput.disabled=true; checkBtn.disabled=true; showFeedback(was.correct, ct.capital, buildExtraInfo(ct,'hard')); }
  }
  prevBtn.disabled = (idx===0);
  nextBtn.textContent = (idx===deck.length-1) ? 'Finish' : 'Next';
}

function renderChoices(opts, correctText){
  choicesEl.innerHTML='';
  opts.forEach(opt=>{
    const b=document.createElement('button'); b.className='choice'; b.textContent=opt;
    b.onclick=()=>handlePick(opt, correctText);
    const was = answered.get(deck[idx]);
    if(was){ b.disabled=true; if(opt===correctText) b.classList.add('correct'); if(was.pick===opt && !was.correct) b.classList.add('wrong'); }
    choicesEl.appendChild(b);
  });
}

function renderFlagChoices(countryNameOptions, correctCountryName){
  choicesEl.innerHTML='';
  countryNameOptions.forEach(name=>{
    const b=document.createElement('button'); b.className='choice flag-btn';
    const img=document.createElement('img'); img.className='flag-img'; img.loading='lazy';
    img.src = flagUrl(name, 200); /* smaller requested width */
    img.alt = `Flag of ${name}`;
    b.appendChild(img);

    if (!HIDE_FLAG_LABELS) {
      const label=document.createElement('div'); label.className='flag-label'; label.textContent = name;
      b.appendChild(label);
    } else {
      b.setAttribute('aria-label', `Flag of ${name}`);
    }

    b.onclick=()=>handlePick(name, correctCountryName);

    const was = answered.get(deck[idx]);
    if(was){
      b.disabled=true;
      if(name===correctCountryName) b.classList.add('correct');
      if(was.pick===name && !was.correct) b.classList.add('wrong');
    }
    choicesEl.appendChild(b);
  });
}

/* --------------------------------------------
   Choice builders
---------------------------------------------*/
function buildCountryChoicesWithRegionalDecoys(country,total){
  const correct=country.name, used=new Set([correct]), decoys=[];
  const same=shuffle(COUNTRIES_CLEAN.filter(s=>s.region===country.region && s!==country).map(s=>s.name));
  while(decoys.length<Math.min(2,total-1) && same.length){ const x=same.pop(); if(!used.has(x)){decoys.push(x); used.add(x);} }
  const others=shuffle(COUNTRIES_CLEAN.filter(s=>s.region!==country.region).map(s=>s.name));
  while(decoys.length<(total-1) && others.length){ const x=others.pop(); if(!used.has(x)){decoys.push(x); used.add(x);} }
  if(decoys.length<(total-1)){ const any=shuffle(COUNTRIES_CLEAN.map(s=>s.name)); while(decoys.length<(total-1)&&any.length){ const x=any.pop(); if(!used.has(x)){decoys.push(x); used.add(x);} } }
  return shuffle([correct, ...decoys]).slice(0,total);
}
function buildCapitalChoicesWithDecoys(country,total){
  const ans=country.capital, decoys=[], used=new Set([ans]);
  shuffle([...(country.cities||[])]).forEach(c=>{ if(decoys.length<Math.min(4,total-1)&&!used.has(c)){ decoys.push(c); used.add(c); } });
  const others=shuffle(capitalNames.filter(c=>!used.has(c)));
  while(decoys.length<(total-1) && others.length){ const x=others.pop(); decoys.push(x); used.add(x); }
  return shuffle([ans, ...decoys]).slice(0,total);
}
function buildFlagChoices(country,total){
  const correct=country.name, used=new Set([correct]), decoys=[];
  const same=shuffle(COUNTRIES_CLEAN.filter(s=>s.region===country.region && s.name!==correct).map(s=>s.name));
  while(decoys.length<Math.min(2,total-1) && same.length){ const x=same.pop(); if(!used.has(x)){decoys.push(x); used.add(x);} }
  const others=shuffle(COUNTRIES_CLEAN.filter(s=>s.region!==country.region && s.name!==correct).map(s=>s.name));
  while(decoys.length<(total-1) && others.length){ const x=others.pop(); if(!used.has(x)){decoys.push(x); used.add(x);} }
  if(decoys.length<(total-1)){
    const any=shuffle(COUNTRIES_CLEAN.map(s=>s.name));
    while(decoys.length<(total-1)&&any.length){ const x=any.pop(); if(!used.has(x)){decoys.push(x); used.add(x);} }
  }
  return shuffle([correct, ...decoys]).slice(0,total);
}

/* --------------------------------------------
   Answering & feedback
---------------------------------------------*/
function handlePick(pick, correctText){
  const code=deck[idx]; const ct=byCode[code];
  if(answered.has(code)) return;
  const ok = pick===correctText;
  answered.set(code,{correct:ok, pick}); if(ok) score++;

  // Disable MCQ buttons + style
  document.querySelectorAll('button.choice').forEach(b=>{
    b.disabled=true;
    const val = b.querySelector('.flag-label')?.textContent || b.textContent || b.getAttribute('aria-label')?.replace(/^Flag of\s+/,'');
    if(val===correctText) b.classList.add('correct');
    if(val===pick && !ok) b.classList.add('wrong');
  });

  // Easy-mode map feedback: wrong pick -> correct turns green, wrong-picked turns red
  if (modeSel.value === 'easy' && !ok) {
    // Correct country -> green
    const correctNodes = findCountryNodes(code, ct.name);
    correctNodes.forEach(el=>{
      el.classList.remove('hl','hl-anim','hl-wrong');
      el.classList.add('hl-correct');
      if (el.querySelectorAll) el.querySelectorAll('*').forEach(ch=>{
        ch.classList.remove('hl','hl-anim','hl-wrong');
        ch.classList.add('hl-correct');
      });
    });
    // Wrong-picked country -> red
    const wrongCountry = COUNTRIES_CLEAN.find(s => s.name === pick);
    if (wrongCountry) {
      const wrongNodes = findCountryNodes(wrongCountry.code, wrongCountry.name);
      wrongNodes.forEach(el=>{
        el.classList.remove('hl','hl-anim','hl-correct');
        el.classList.add('hl-wrong');
        if (el.querySelectorAll) el.querySelectorAll('*').forEach(ch=>{
          ch.classList.remove('hl','hl-anim','hl-correct');
          ch.classList.add('hl-wrong');
        });
      });
    }
  }

  const revealMode = modeSel.value==='flag' ? 'flag' : modeSel.value;
  const correctStr = (modeSel.value==='flag') ? `${ct.name} (correct flag)` : correctText;
  showFeedback(ok, correctStr, buildExtraInfo(ct, revealMode));
  updateHeader();
}

function registerAnswer(code, ok, pick, correctText){
  const ct=byCode[code]; if(answered.has(code)) return;
  answered.set(code,{correct:ok, pick}); if(ok) score++;
  showFeedback(ok, correctText, buildExtraInfo(ct, modeSel.value)); updateHeader();
}
function showFeedback(isCorrect, correctText, extraHTML=""){
  feedbackEl.innerHTML = isCorrect
    ? `✅ Correct!${extraHTML ? `<div>${extraHTML}</div>` : ''}`
    : `❌ Incorrect. Correct answer: ${correctText}${extraHTML ? `<div>${extraHTML}</div>` : ''}`;
  feedbackEl.classList.remove('hide');
}

/* --------------------------------------------
   Wrong review dialog
---------------------------------------------*/
wrongBtn.onclick = ()=>{ buildWrongList(); if(typeof wrongDlg.showModal === 'function'){ wrongDlg.showModal(); } else { wrongDlg.setAttribute('open','open'); } };
closeWrong.onclick = ()=> wrongDlg.close();
function buildWrongList(){
  wrongList.innerHTML = '';
  const wr=wrongCodes();
  if(!wr.length){ wrongList.innerHTML='<p class="small">Nothing to review—nice!</p>'; return; }
  wr.forEach(code=>{
    const ct=byCode[code], res=answered.get(code);
    const li=document.createElement('div'); li.className='row';
    li.innerHTML = `<h4>${ct.name}</h4><p class="mine">Your answer: ${res.pick??'(blank)'}</p><p class="correct">Correct: ${ct.capital}</p>`;
    const jump=document.createElement('button'); jump.className='btn jump'; jump.textContent='Jump to this question';
    jump.onclick=()=>{ const pos=deck.indexOf(code); if(pos!==-1){ idx=pos; render(); wrongDlg.close(); } else { wrongDlg.close(); deck=shuffle([code,...COUNTRIES_CLEAN.map(s=>s.code).filter(c=>c!==code)]); idx=0; score=0; answered.clear(); wrongOnly=false; render(); } };
    li.appendChild(jump); wrongList.appendChild(li);
  });
}

/* --------------------------------------------
   Controls & keyboard
---------------------------------------------*/
prevBtn.onclick = prevQuestion;
nextBtn.onclick = nextQuestion;
restartBtn.onclick = ()=>{ makeFullDeck(); render(); };
shuffleBtn.onclick = ()=>{ makeFullDeck(); render(); };
retakeWrongBtn.onclick = ()=>{ makeWrongOnlyDeck(); render(); };
modeSel.onchange = ()=>{ score=0; answered.clear(); idx=0; render(); };

choiceCountSel.value = String(MCQ_CHOICES);
choiceCountSel.onchange = ()=>{ MCQ_CHOICES = clamp(parseInt(choiceCountSel.value,10),5,9); localStorage.setItem('eu_mcq_choices', String(MCQ_CHOICES)); render(); };
revealCapitalChk.checked = REVEAL_CAPITAL;
revealCapitalChk.onchange = ()=>{ REVEAL_CAPITAL = revealCapitalChk.checked; localStorage.setItem('eu_reveal_capital', REVEAL_CAPITAL?'1':'0'); render(); };
showFlagChk.checked = SHOW_FLAG;
showFlagChk.onchange = ()=>{ SHOW_FLAG = showFlagChk.checked; localStorage.setItem('eu_show_flag', SHOW_FLAG?'1':'0'); render(); };

hideFlagLabelsChk.checked = HIDE_FLAG_LABELS;
hideFlagLabelsChk.onchange = ()=>{ HIDE_FLAG_LABELS = hideFlagLabelsChk.checked; localStorage.setItem('eu_hide_flag_labels', HIDE_FLAG_LABELS?'1':'0'); render(); };

hideFlagQuestionChk.checked = HIDE_FLAG_QUESTION;
hideFlagQuestionChk.onchange = ()=>{ HIDE_FLAG_QUESTION = hideFlagQuestionChk.checked; localStorage.setItem('eu_hide_flag_question', HIDE_FLAG_QUESTION?'1':'0'); render(); };

document.addEventListener('keydown', (e)=>{
  const mode=modeSel.value;
  if(mode==='hard'){ if(e.key==='Enter') checkBtn.click(); }
  else {
    const n = parseInt(e.key,10);
    if(!isNaN(n) && n>=1 && n<=MCQ_CHOICES){
      const btns = choicesEl.querySelectorAll('button.choice');
      const btn = btns[n-1];
      if(btn && !btn.disabled) btn.click();
    }
  }
});

/* --------------------------------------------
   Start
---------------------------------------------*/
(async function init(){
  await loadSvgFromUrl();
  makeFullDeck();
  render();
})();
</script>
</body>
</html>
